name: Reusable (Release Tag)

on:
  workflow_call:
    inputs:
      artifact_name:
        description: 'Artifact name prefix for release files'
        required: false
        type: string
        default: 'open-coreui'
      version:
        description: 'Version from get-version workflow'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
      version: ${{ inputs.version }}
      is_stable: ${{ steps.release_info.outputs.is_release == 'true' && steps.release_info.outputs.prerelease == 'false' }}
      is_release: ${{ steps.release_info.outputs.is_release }}
      prerelease: ${{ steps.release_info.outputs.prerelease }}

    steps:
      - uses: actions/checkout@v5

      - name: Download Backend Full Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-full-*
          merge-multiple: true

      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: desktop-*
          merge-multiple: true

      - name: Download Slim Backend Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-slim-*
          merge-multiple: true

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/frontend-build
          pattern: frontend-build

      - name: Organize Release Assets
        run: |
          chmod +x .github/scripts/release/common/organize-assets.sh
          .github/scripts/release/common/organize-assets.sh \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "false"

      - name: Generate Checksums
        run: |
          chmod +x .github/scripts/release/common/generate-checksums.sh
          .github/scripts/release/common/generate-checksums.sh

      - name: Determine Release Type
        id: release_info
        run: |
          chmod +x .github/scripts/release/tag/determine-type.sh
          .github/scripts/release/tag/determine-type.sh "${{ github.ref }}"

      - name: Generate Release Body
        id: generate_body
        run: |
          chmod +x .github/scripts/release/tag/generate-body.sh
          .github/scripts/release/tag/generate-body.sh \
            "${{ steps.release_info.outputs.tag_name }}" \
            "${{ github.repository }}" \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "${{ steps.release_info.outputs.is_release }}"
          
          {
            echo "body<<EOFMARKER"
            cat release_body.md
            echo "EOFMARKER"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.is_release == 'true' && format('Release {0}', steps.release_info.outputs.tag_name) || format('Development Build ({0})', steps.release_info.outputs.tag_name) }}
          body: ${{ steps.generate_body.outputs.body }}
          files: release-assets/*
          prerelease: ${{ steps.release_info.outputs.prerelease }}
          draft: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-latest:
    needs: release
    if: needs.release.outputs.is_stable == 'true'
    uses: ./.github/workflows/component-update-latest-release.yml
    with:
      source_tag: ${{ needs.release.outputs.tag_name }}
      version: ${{ needs.release.outputs.version }}
      artifact_name: ${{ inputs.artifact_name }}
      is_manual: false