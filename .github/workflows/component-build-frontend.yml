name: Reusable (Build Frontend)

on:
  workflow_call:
    outputs:
      cache-hit:
        description: "Whether frontend build was found in cache"
        value: ${{ jobs.build-frontend.outputs.cache-hit }}

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-frontend.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Generate Frontend Cache Key
        id: frontend-hash
        run: |
          HASH=$(find frontend/src frontend/static frontend/package.json frontend/bun.lock frontend/vite.config.ts frontend/svelte.config.js frontend/tailwind.config.js -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: frontend/build/
          key: frontend-build-${{ steps.frontend-hash.outputs.hash }}
          restore-keys: |
            frontend-build-

      - uses: oven-sh/setup-bun@v2
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        with:
          bun-version: latest

      - name: Cache Bun Dependencies
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: make build-frontend

      - uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 1