name: Reusable (Release Manual)

on:
  workflow_call:
    inputs:
      release_tag:
        description: 'Release Tag (e.g., v0.9.7-test or leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      artifact_name:
        description: 'Artifact name prefix for release files'
        required: false
        type: string
        default: 'open-coreui'
      version:
        description: 'Version from get-version workflow'
        required: true
        type: string
      update_latest_release:
        description: 'Update "latest" release (for stable releases only)'
        required: false
        type: boolean
        default: false
      docker_images_built:
        description: 'Comma-separated list of built Docker image types (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  release-manual:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
      version: ${{ inputs.version }}

    steps:
      - uses: actions/checkout@v5

      - name: Download Backend Full Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-full-*
          merge-multiple: true

      - name: Download Desktop Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: desktop-*
          merge-multiple: true

      - name: Download Slim Backend Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-slim-*
          merge-multiple: true

      - name: Download Frontend Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts/frontend-build
          pattern: frontend-build

      - name: Scan Available Artifacts
        id: scan
        run: |
          chmod +x .github/scripts/release/manual/scan-artifacts.sh
          .github/scripts/release/manual/scan-artifacts.sh "${{ inputs.artifact_name }}"

      - name: Organize Release Assets
        run: |
          chmod +x .github/scripts/release/common/organize-assets.sh
          .github/scripts/release/common/organize-assets.sh \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "true"

      - name: Generate Checksums
        run: |
          chmod +x .github/scripts/release/common/generate-checksums.sh
          .github/scripts/release/common/generate-checksums.sh

      - name: Determine Release Tag
        id: release_info
        run: |
          chmod +x .github/scripts/release/manual/determine-tag.sh
          .github/scripts/release/manual/determine-tag.sh "${{ inputs.release_tag }}"

      - name: Generate Dynamic Release Body
        id: generate_body
        run: |
          chmod +x .github/scripts/release/manual/generate-body.sh
          .github/scripts/release/manual/generate-body.sh \
            "${{ steps.release_info.outputs.tag_name }}" \
            "${{ github.repository }}" \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "${{ steps.scan.outputs.has_desktop }}" \
            "${{ steps.scan.outputs.has_backend }}" \
            "${{ steps.scan.outputs.has_backend_slim }}" \
            "${{ steps.scan.outputs.has_frontend }}" \
            "${{ inputs.docker_images_built }}"
          
          {
            echo "body<<EOFMARKER"
            cat release_body.md
            echo "EOFMARKER"
          } >> $GITHUB_OUTPUT

      - name: Create Manual Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: Manual Release (${{ steps.release_info.outputs.tag_name }})
          body: ${{ steps.generate_body.outputs.body }}
          files: release-assets/*
          prerelease: true
          draft: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-latest:
    needs: release-manual
    if: inputs.update_latest_release == true
    uses: ./.github/workflows/component-update-latest-release.yml
    with:
      source_tag: ${{ needs.release-manual.outputs.tag_name }}
      version: ${{ needs.release-manual.outputs.version }}
      artifact_name: ${{ inputs.artifact_name }}
      is_manual: true