name: Reusable (Update Latest Release)

on:
  workflow_call:
    inputs:
      source_tag:
        description: 'Source tag name (e.g., v1.2.3)'
        required: true
        type: string
      version:
        description: 'Version number without v prefix (e.g., 1.2.3)'
        required: true
        type: string
      artifact_name:
        description: 'Artifact name prefix for release files'
        required: false
        type: string
        default: 'open-coreui'
      is_manual:
        description: 'Is this a manual release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-latest:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Download Backend Full Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-full-*
          merge-multiple: true

      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: desktop-*
          merge-multiple: true

      - name: Download Slim Backend Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-slim-*
          merge-multiple: true

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/frontend-build
          pattern: frontend-build

      - name: Organize Release Assets
        run: |
          chmod +x .github/scripts/release/common/organize-assets.sh
          .github/scripts/release/common/organize-assets.sh \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "false"

      - name: Update Latest Git Tag
        run: |
          chmod +x .github/scripts/release/latest/update-git-tag.sh
          .github/scripts/release/latest/update-git-tag.sh \
            "${{ inputs.source_tag }}" \
            "${{ inputs.is_manual }}"

      - name: Create Latest Release Assets
        run: |
          chmod +x .github/scripts/release/latest/create-assets.sh
          .github/scripts/release/latest/create-assets.sh \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}"

      - name: Generate Latest Release Body
        id: generate_body
        run: |
          chmod +x .github/scripts/release/latest/generate-body.sh
          .github/scripts/release/latest/generate-body.sh \
            "${{ inputs.source_tag }}" \
            "${{ github.repository }}" \
            "${{ inputs.version }}" \
            "${{ inputs.artifact_name }}" \
            "${{ inputs.is_manual }}"
          
          {
            echo "body<<EOFMARKER"
            cat release_body_latest.md
            echo "EOFMARKER"
          } >> $GITHUB_OUTPUT

      - name: Create/Update Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ inputs.is_manual && 'Latest Release (Manual)' || 'Latest Stable Release' }}
          body: ${{ steps.generate_body.outputs.body }}
          files: release-assets-latest/*
          prerelease: false
          draft: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}