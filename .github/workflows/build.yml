name: Build and Release

on:
  workflow_dispatch:
    inputs:
      build_frontend:
        description: 'üé® Build Frontend (auto-enabled if Backend or Desktop selected)'
        required: false
        type: boolean
        default: true
      build_backend:
        description: 'üîß Build Backend Full (with embedded Frontend) ‚Üí auto-enables Frontend'
        required: false
        type: boolean
        default: true
      build_backend_slim:
        description: '‚ö° Build Backend Slim (without Frontend, independent)'
        required: false
        type: boolean
        default: true
      build_desktop:
        description: 'üñ•Ô∏è Build Desktop Application ‚Üí auto-enables Frontend + Backend'
        required: false
        type: boolean
        default: true
      target_platforms:
        description: 'Target Platforms (comma-separated: linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64, or "all")'
        required: false
        type: string
        default: 'all'
      create_release:
        description: 'Create Release (for manual testing)'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release Tag (e.g., v0.9.7-test or leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      update_latest_release:
        description: 'üè∑Ô∏è Update "latest" release (for stable releases)'
        required: false
        type: boolean
        default: false
      build_docker_images:
        description: 'üê≥ Build Docker Images'
        required: false
        type: boolean
        default: false
      docker_image_types:
        description: 'Docker Image Types (all, backend, frontend, complex, or comma-separated)'
        required: false
        type: string
        default: 'all'
      docker_platforms:
        description: 'Docker Platforms (all, linux-x64, linux-arm64, or comma-separated)'
        required: false
        type: string
        default: 'all'
  push:
    branches:
      - main
    tags:
      - "v*"
    paths:
      - "backend/**"
      - "frontend/**"
      - "src-tauri/**"
      - ".github/workflows/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BINARY_NAME: open-webui-rust
  ARTIFACT_NAME: open-coreui

jobs:
  # Get version for all components
  get-version:
    uses: ./.github/workflows/component-get-version.yml
    with:
      release_tag: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || '' }}

  # Compute effective build flags based on dependencies
  compute-build-flags:
    runs-on: ubuntu-latest
    outputs:
      build_frontend: ${{ steps.flags.outputs.build_frontend }}
      build_backend: ${{ steps.flags.outputs.build_backend }}
      build_backend_slim: ${{ steps.flags.outputs.build_backend_slim }}
      build_desktop: ${{ steps.flags.outputs.build_desktop }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Compute build flags
        id: flags
        run: |
          chmod +x .github/scripts/build/compute-flags.sh
          .github/scripts/build/compute-flags.sh \
            "${{ github.event_name }}" \
            "${{ inputs.build_frontend }}" \
            "${{ inputs.build_backend }}" \
            "${{ inputs.build_backend_slim }}" \
            "${{ inputs.build_desktop }}"

  # Build frontend once and cache it
  build-frontend:
    needs: compute-build-flags
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_frontend == 'true')
    uses: ./.github/workflows/component-build-frontend.yml

  # Build slim backend binaries (no frontend embedded) for all platforms
  build-backend-slim:
    needs: compute-build-flags
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_backend_slim == 'true')
    uses: ./.github/workflows/component-build-backend-slim.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
      binary_name: ${{ vars.BINARY_NAME || 'open-webui-rust' }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build full backend binaries (with embedded frontend) for all platforms
  build-backend-full:
    needs: [compute-build-flags, build-frontend]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      ((github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_backend == 'true'))
    uses: ./.github/workflows/component-build-backend-full.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
      binary_name: ${{ vars.BINARY_NAME || 'open-webui-rust' }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build desktop application for all platforms
  build-desktop:
    needs: [get-version, compute-build-flags, build-backend-full]
    if: |
      always() &&
      (needs.build-backend-full.result == 'success' || needs.build-backend-full.result == 'skipped') &&
      ((github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_desktop == 'true'))
    uses: ./.github/workflows/component-build-desktop.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
      release_version: ${{ needs.get-version.outputs.version }}
    secrets:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

  # Build Docker images for version tags (before release creation)
  build-docker-release:
    needs: [get-version, build-frontend, build-backend-full, build-desktop, build-backend-slim]
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: 'all'
      docker_platforms: 'all'
      version: ${{ needs.get-version.outputs.version }}
      update_latest_tag: false
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build Docker images for latest (only for stable releases, before release creation)
  build-docker-latest:
    needs: [get-version, build-frontend, build-backend-full, build-desktop, build-backend-slim]
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      !contains(github.ref, '-')
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: 'all'
      docker_platforms: 'all'
      version: ${{ needs.get-version.outputs.version }}
      update_latest_tag: true
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Create release for version tags (after Docker images are built)
  release-tag:
    needs: [get-version, build-frontend, build-backend-full, build-desktop, build-backend-slim, build-docker-release, build-docker-latest]
    if: |
      always() &&
      (needs.build-docker-release.result == 'success' || needs.build-docker-release.result == 'skipped') &&
      (needs.build-docker-latest.result == 'success' || needs.build-docker-latest.result == 'skipped') &&
      startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/component-release-tag.yml
    with:
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}
      version: ${{ needs.get-version.outputs.version }}

  # Build Docker images for manual workflow (independent of release creation)
  build-docker-manual:
    needs: [get-version, build-frontend, build-backend-full, build-desktop, build-backend-slim]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-backend-full.result == 'success' || needs.build-backend-full.result == 'skipped') &&
      (needs.build-desktop.result == 'success' || needs.build-desktop.result == 'skipped') &&
      (needs.build-backend-slim.result == 'success' || needs.build-backend-slim.result == 'skipped') &&
      github.event_name == 'workflow_dispatch' &&
      inputs.build_docker_images == true
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: ${{ inputs.docker_image_types }}
      docker_platforms: ${{ inputs.docker_platforms }}
      version: ${{ needs.get-version.outputs.version }}
      update_latest_tag: ${{ inputs.update_latest_release }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Create manual/test release
  release-manual:
    needs: [get-version, build-frontend, build-backend-full, build-desktop, build-backend-slim, build-docker-manual]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-backend-full.result == 'success' || needs.build-backend-full.result == 'skipped') &&
      (needs.build-desktop.result == 'success' || needs.build-desktop.result == 'skipped') &&
      (needs.build-backend-slim.result == 'success' || needs.build-backend-slim.result == 'skipped') &&
      (needs.build-docker-manual.result == 'success' || needs.build-docker-manual.result == 'skipped') &&
      github.event_name == 'workflow_dispatch' && inputs.create_release == true
    uses: ./.github/workflows/component-release-manual.yml
    with:
      release_tag: ${{ inputs.release_tag }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}
      version: ${{ needs.get-version.outputs.version }}
      update_latest_release: ${{ inputs.update_latest_release }}
      docker_images_built: ${{ needs.build-docker-manual.outputs.image_types_built || '' }}
