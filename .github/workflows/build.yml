name: Build and Release

on:
  workflow_dispatch:
    inputs:
      build_frontend:
        description: 'ðŸŽ¨ Build Frontend (auto-enabled if Backend or Desktop selected)'
        required: false
        type: boolean
        default: true
      build_backend:
        description: 'ðŸ”§ Build Backend Full (with embedded Frontend) â†’ auto-enables Frontend'
        required: false
        type: boolean
        default: true
      build_backend_slim:
        description: 'âš¡ Build Backend Slim (without Frontend, independent)'
        required: false
        type: boolean
        default: true
      build_desktop:
        description: 'ðŸ–¥ï¸ Build Desktop Application â†’ auto-enables Frontend + Backend'
        required: false
        type: boolean
        default: true
      target_platforms:
        description: 'Target Platforms (comma-separated: linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64, or "all")'
        required: false
        type: string
        default: 'all'
      create_release:
        description: 'Create Release (for manual testing)'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release Tag (e.g., v0.9.7-test or leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      update_latest_release:
        description: 'ðŸ·ï¸ Update "latest" release (for stable releases)'
        required: false
        type: boolean
        default: false
      build_docker_images:
        description: 'ðŸ³ Build Docker Images'
        required: false
        type: boolean
        default: false
      docker_image_types:
        description: 'Docker Image Types (all, backend, frontend, complex, or comma-separated)'
        required: false
        type: string
        default: 'all'
      docker_platforms:
        description: 'Docker Platforms (all, linux-x64, linux-arm64, or comma-separated)'
        required: false
        type: string
        default: 'all'
  push:
    branches:
      - main
    tags:
      - "v*"
    paths:
      - "backend/**"
      - "frontend/**"
      - "src-tauri/**"
      - ".github/workflows/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BINARY_NAME: open-webui-rust
  ARTIFACT_NAME: open-coreui

jobs:
  # Compute effective build flags based on dependencies
  compute-build-flags:
    runs-on: ubuntu-latest
    outputs:
      build_frontend: ${{ steps.flags.outputs.build_frontend }}
      build_backend: ${{ steps.flags.outputs.build_backend }}
      build_backend_slim: ${{ steps.flags.outputs.build_backend_slim }}
      build_desktop: ${{ steps.flags.outputs.build_desktop }}
    steps:
      - name: Compute build flags
        id: flags
        run: |
          # For push events, build everything
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "build_frontend=true" >> $GITHUB_OUTPUT
            echo "build_backend=true" >> $GITHUB_OUTPUT
            echo "build_backend_slim=true" >> $GITHUB_OUTPUT
            echo "build_desktop=true" >> $GITHUB_OUTPUT
          else
            # For manual dispatch, compute dependencies
            BUILD_FRONTEND="${{ inputs.build_frontend }}"
            BUILD_BACKEND="${{ inputs.build_backend }}"
            BUILD_BACKEND_SLIM="${{ inputs.build_backend_slim }}"
            BUILD_DESKTOP="${{ inputs.build_desktop }}"
            
            # If backend is selected, frontend must be built
            if [[ "$BUILD_BACKEND" == "true" ]]; then
              echo "::notice::Backend selected - automatically enabling Frontend"
              BUILD_FRONTEND="true"
            fi
            
            # If desktop is selected, backend must be built (backend includes frontend)
            if [[ "$BUILD_DESKTOP" == "true" ]]; then
              echo "::notice::Desktop selected - automatically enabling Frontend and Backend"
              BUILD_FRONTEND="true"
              BUILD_BACKEND="true"
            fi
            
            echo "build_frontend=$BUILD_FRONTEND" >> $GITHUB_OUTPUT
            echo "build_backend=$BUILD_BACKEND" >> $GITHUB_OUTPUT
            echo "build_backend_slim=$BUILD_BACKEND_SLIM" >> $GITHUB_OUTPUT
            echo "build_desktop=$BUILD_DESKTOP" >> $GITHUB_OUTPUT
            
            # Log final build configuration
            echo "::notice::Build configuration: Frontend=$BUILD_FRONTEND, Backend=$BUILD_BACKEND, Backend-Slim=$BUILD_BACKEND_SLIM, Desktop=$BUILD_DESKTOP"
          fi

  # Build frontend once and cache it
  build-frontend:
    needs: compute-build-flags
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_frontend == 'true')
    uses: ./.github/workflows/component-build-frontend.yml

  # Build slim backend binaries (no frontend embedded) for all platforms
  build-backend-slim:
    needs: compute-build-flags
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_backend_slim == 'true')
    uses: ./.github/workflows/component-build-backend-slim.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
      binary_name: ${{ vars.BINARY_NAME || 'open-webui-rust' }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build full backend binaries (with embedded frontend) for all platforms
  build-backend-full:
    needs: [compute-build-flags, build-frontend]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      ((github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_backend == 'true'))
    uses: ./.github/workflows/component-build-backend-full.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
      binary_name: ${{ vars.BINARY_NAME || 'open-webui-rust' }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build desktop application for all platforms
  build-desktop:
    needs: [compute-build-flags, build-backend-full]
    if: |
      always() &&
      (needs.build-backend-full.result == 'success' || needs.build-backend-full.result == 'skipped') &&
      ((github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && needs.compute-build-flags.outputs.build_desktop == 'true'))
    uses: ./.github/workflows/component-build-desktop.yml
    with:
      target_platforms: ${{ github.event_name == 'workflow_dispatch' && inputs.target_platforms || 'all' }}
    secrets:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

  # Create release for version tags
  release-tag:
    needs: [build-frontend, build-backend-full, build-desktop, build-backend-slim]
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/component-release-tag.yml
    with:
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build Docker images after tag release (version tags only, no latest)
  build-docker-release:
    needs: [release-tag]
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: 'all'
      docker_platforms: 'all'
      version: ${{ needs.release-tag.outputs.version }}
      update_latest_tag: false
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Build Docker images for latest (only when latest release is updated)
  build-docker-latest:
    needs: [release-tag]
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      needs.release-tag.outputs.is_stable == 'true'
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: 'all'
      docker_platforms: 'all'
      version: ${{ needs.release-tag.outputs.version }}
      update_latest_tag: true
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}

  # Create manual/test release
  release-manual:
    needs: [build-frontend, build-backend-full, build-desktop, build-backend-slim]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-backend-full.result == 'success' || needs.build-backend-full.result == 'skipped') &&
      (needs.build-desktop.result == 'success' || needs.build-desktop.result == 'skipped') &&
      (needs.build-backend-slim.result == 'success' || needs.build-backend-slim.result == 'skipped') &&
      github.event_name == 'workflow_dispatch' && inputs.create_release == true
    uses: ./.github/workflows/component-release-manual.yml
    with:
      release_tag: ${{ inputs.release_tag }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}
      update_latest_release: ${{ inputs.update_latest_release }}

  # Build Docker images for manual releases
  build-docker-manual:
    needs: [release-manual]
    if: |
      always() &&
      needs.release-manual.result == 'success' &&
      github.event_name == 'workflow_dispatch' &&
      inputs.build_docker_images == true
    uses: ./.github/workflows/component-build-docker.yml
    with:
      image_types: ${{ inputs.docker_image_types }}
      docker_platforms: ${{ inputs.docker_platforms }}
      version: ${{ needs.release-manual.outputs.version }}
      update_latest_tag: ${{ inputs.update_latest_release }}
      artifact_name: ${{ vars.ARTIFACT_NAME || 'open-coreui' }}