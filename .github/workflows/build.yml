name: Build and Release

on:
  workflow_dispatch:
    inputs:
      build_frontend:
        description: 'Build Frontend'
        required: false
        type: boolean
        default: true
      build_backend:
        description: 'Build Backend (Full with Frontend)'
        required: false
        type: boolean
        default: true
      build_backend_slim:
        description: 'Build Backend (Slim without Frontend)'
        required: false
        type: boolean
        default: true
      build_desktop:
        description: 'Build Desktop Application'
        required: false
        type: boolean
        default: true
      target_platforms:
        description: 'Target Platforms (comma-separated: linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64, or "all")'
        required: false
        type: string
        default: 'all'
      create_release:
        description: 'Create Release (for manual testing)'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release Tag (e.g., v0.9.7-test or leave empty for auto-generated)'
        required: false
        type: string
        default: ''
  push:
    branches:
      - main
    tags:
      - "v*"
    paths:
      - "backend/**"
      - "frontend/**"
      - "src-tauri/**"
      - ".github/workflows/build.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  # Build frontend once and cache it
  build-frontend:
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.build_frontend == true)
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-frontend.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Generate Frontend Cache Key
        id: frontend-hash
        run: |
          HASH=$(find frontend/src frontend/static frontend/package.json frontend/bun.lock frontend/vite.config.ts frontend/svelte.config.js frontend/tailwind.config.js -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: frontend/build/
          key: frontend-build-${{ steps.frontend-hash.outputs.hash }}
          restore-keys: |
            frontend-build-

      - uses: oven-sh/setup-bun@v2
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        with:
          bun-version: latest

      - name: Cache Bun Dependencies
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            frontend/node_modules
            ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: make build-frontend

      - uses: actions/upload-artifact@v5
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 1

  # Build slim backend binaries (no frontend embedded) for all platforms
  build-backend-slim:
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.build_backend_slim == true)
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            platform_id: linux-x64
          - platform: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            platform_id: linux-arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            platform_id: macos-x64
          - platform: macos-latest
            target: aarch64-apple-darwin
            platform_id: macos-arm64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            platform_id: windows-x64
          - platform: windows-latest
            target: aarch64-pc-windows-msvc
            platform_id: windows-arm64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Check if platform should be built
        id: should_build
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.target_platforms }}" != "all" ]]; then
            if [[ "${{ inputs.target_platforms }}" == *"${{ matrix.platform_id }}"* ]]; then
              echo "build=true" >> $GITHUB_OUTPUT
            else
              echo "build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "build=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v5
        if: steps.should_build.outputs.build == 'true'
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        if: steps.should_build.outputs.build == 'true'
        with:
          targets: ${{ matrix.target }}

      - name: Install sccache
        if: steps.should_build.outputs.build == 'true'
        uses: mozilla-actions/sccache-action@v0.0.9

      - uses: swatinem/rust-cache@v2
        if: steps.should_build.outputs.build == 'true'
        with:
          workspaces: backend -> target
          key: ${{ matrix.target }}-slim
          cache-all-crates: true
          shared-key: "rust-build-slim"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install Linux Dependencies
        if: steps.should_build.outputs.build == 'true' && runner.os == 'Linux'
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            sudo dpkg --add-architecture arm64
            sudo sed -i 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list
            sudo sed -i 's/deb mirror/deb [arch=amd64] mirror/g' /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy universe" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates universe" | sudo tee -a /etc/apt/sources.list
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libssl-dev:arm64
          else
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          fi

      - name: Build Backend Slim (Unix)
        if: steps.should_build.outputs.build == 'true' && runner.os != 'Windows'
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          OPENSSL_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          OPENSSL_INCLUDE_DIR: ${{ (matrix.target == 'aarch64-unknown-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu') && '/usr/include' || '' }}
          OPENSSL_LIB_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
          PKG_CONFIG_PATH: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu/pkgconfig' || '' }}
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
        run: |
          mkdir -p bin
          cd backend
          cargo fetch --target ${{ matrix.target }}
          cargo build --release --no-default-features --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/open-webui-rust ../bin/open-coreui-slim-${{ matrix.target }}

      - name: Build Backend Slim (Windows)
        if: steps.should_build.outputs.build == 'true' && runner.os == 'Windows'
        env:
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
        run: |
          mkdir bin
          cd backend
          cargo fetch --target ${{ matrix.target }}
          cargo build --release --no-default-features --target ${{ matrix.target }}
          copy target/${{ matrix.target }}/release/open-webui-rust.exe ..\bin\open-coreui-slim-${{ matrix.target }}.exe

      - name: Upload Slim Backend Artifacts
        if: steps.should_build.outputs.build == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: backend-slim-${{ matrix.target }}
          path: bin/open-coreui-slim-${{ matrix.target }}*
          if-no-files-found: error
          retention-days: ${{ startsWith(github.ref, 'refs/tags/v') && 90 || 30 }}

  # Build backend and desktop in one job
  build:
    needs: build-frontend
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      ((github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && (inputs.build_backend == true || inputs.build_desktop == true)))
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            platform_id: linux-x64
          - platform: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            platform_id: linux-arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            platform_id: macos-x64
          - platform: macos-latest
            target: aarch64-apple-darwin
            platform_id: macos-arm64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            platform_id: windows-x64
          - platform: windows-latest
            target: aarch64-pc-windows-msvc
            platform_id: windows-arm64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Check if platform should be built
        id: should_build
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.target_platforms }}" != "all" ]]; then
            if [[ "${{ inputs.target_platforms }}" == *"${{ matrix.platform_id }}"* ]]; then
              echo "build=true" >> $GITHUB_OUTPUT
            else
              echo "build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "build=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v5
        if: steps.should_build.outputs.build == 'true'
        with:
          submodules: recursive

      - uses: oven-sh/setup-bun@v2
        if: steps.should_build.outputs.build == 'true'
        with:
          bun-version: latest

      - uses: dtolnay/rust-toolchain@stable
        if: steps.should_build.outputs.build == 'true'
        with:
          targets: ${{ matrix.target }}

      - name: Install sccache
        if: steps.should_build.outputs.build == 'true'
        uses: mozilla-actions/sccache-action@v0.0.9

      - uses: swatinem/rust-cache@v2
        if: steps.should_build.outputs.build == 'true'
        with:
          workspaces: |
            backend -> target
            src-tauri -> target
          key: ${{ matrix.target }}
          cache-all-crates: true
          shared-key: "rust-build"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache Tauri CLI
        if: steps.should_build.outputs.build == 'true'
        id: cache-tauri-cli
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-tauri
          key: tauri-cli-2.0.0-${{ runner.os }}

      - name: Install Tauri CLI
        if: steps.should_build.outputs.build == 'true' && steps.cache-tauri-cli.outputs.cache-hit != 'true'
        env:
          RUSTC_WRAPPER: ""
        run: cargo install tauri-cli --version "^2.0.0" --locked --force

      - name: Download Frontend Build
        if: steps.should_build.outputs.build == 'true'
        uses: actions/download-artifact@v6
        with:
          name: frontend-build
          path: frontend/build/

      - name: Install Linux Dependencies
        if: steps.should_build.outputs.build == 'true' && runner.os == 'Linux'
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            # For ARM64 cross-compilation, configure multi-arch first
            sudo dpkg --add-architecture arm64
            sudo sed -i 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list
            sudo sed -i 's/deb mirror/deb [arch=amd64] mirror/g' /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy universe" | sudo tee -a /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates universe" | sudo tee -a /etc/apt/sources.list
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            sudo apt-get install -y libssl-dev:arm64 libwebkit2gtk-4.1-dev:arm64 libappindicator3-dev:arm64 librsvg2-dev:arm64 patchelf
          else
            sudo apt-get update
            sudo apt-get install -y libssl-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          fi

      - name: Build Backend (Unix)
        if: |
          steps.should_build.outputs.build == 'true' &&
          runner.os != 'Windows' &&
          ((github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_backend == true))
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          OPENSSL_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          OPENSSL_INCLUDE_DIR: ${{ (matrix.target == 'aarch64-unknown-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu') && '/usr/include' || '' }}
          OPENSSL_LIB_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
          PKG_CONFIG_PATH: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu/pkgconfig' || '' }}
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
        run: |
          mkdir -p bin
          cd backend
          cargo fetch --target ${{ matrix.target }}
          cargo build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/open-webui-rust ../bin/open-coreui-${{ matrix.target }}

      - name: Build Backend (Windows)
        if: |
          steps.should_build.outputs.build == 'true' &&
          runner.os == 'Windows' &&
          ((github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_backend == true))
        env:
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
        run: |
          mkdir bin
          cd backend
          cargo build --release --target ${{ matrix.target }}
          copy target/${{ matrix.target }}/release/open-webui-rust.exe ..\bin\open-coreui-${{ matrix.target }}.exe

      - name: Build Desktop (Unix)
        if: |
          steps.should_build.outputs.build == 'true' &&
          runner.os != 'Windows' &&
          ((github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_desktop == true))
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          PKG_CONFIG_SYSROOT_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/aarch64-linux-gnu' || '' }}
          OPENSSL_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          OPENSSL_INCLUDE_DIR: ${{ (matrix.target == 'aarch64-unknown-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu') && '/usr/include' || '' }}
          OPENSSL_LIB_DIR: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu' || matrix.target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu' || '' }}
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
          PKG_CONFIG_PATH: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu/pkgconfig' || '' }}
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          cd src-tauri
          cargo fetch --target ${{ matrix.target }}
          cd ..
          cargo tauri build --target ${{ matrix.target }}

      - name: Build Desktop (Windows)
        if: |
          steps.should_build.outputs.build == 'true' &&
          runner.os == 'Windows' &&
          ((github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_desktop == true))
        env:
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_INCREMENTAL: 0
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          cd src-tauri
          cargo fetch --target ${{ matrix.target }}
          cd ..
          cargo tauri build --target ${{ matrix.target }}

      - name: Upload Artifacts
        if: steps.should_build.outputs.build == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: build-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*
            bin/open-coreui-${{ matrix.target }}*
          if-no-files-found: error
          retention-days: ${{ startsWith(github.ref, 'refs/tags/v') && 90 || 30 }}

  release:
    needs: [build, build-backend-slim]
    if: |
      always() &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.build-backend-slim.result == 'success' || needs.build-backend-slim.result == 'skipped') &&
      (startsWith(github.ref, 'refs/tags/v') ||
       (github.event_name == 'workflow_dispatch' && inputs.create_release == true))
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - name: Download Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: build-*

      - name: Download Slim Backend Artifacts
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-slim-*

      - name: Organize Release Assets
        run: |
          mkdir -p release-assets

          VERSION=$(cat src-tauri/tauri.conf.json | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')

          # Copy desktop app packages (only the final installer packages)
          find artifacts -name "*.deb" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.rpm" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.dmg" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.msi" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*-setup.exe" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.app.tar.gz" -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find artifacts -name "*.AppImage" -type f -exec cp {} release-assets/ \; 2>/dev/null || true

          # Copy and rename backend binaries with version (only if they exist)
          [ -d "artifacts/build-x86_64-unknown-linux-gnu" ] && find artifacts/build-x86_64-unknown-linux-gnu -name "open-coreui-x86_64-unknown-linux-gnu" -type f -exec cp {} release-assets/open-coreui-${VERSION}-x86_64-unknown-linux-gnu \; 2>/dev/null || true
          [ -d "artifacts/build-aarch64-unknown-linux-gnu" ] && find artifacts/build-aarch64-unknown-linux-gnu -name "open-coreui-aarch64-unknown-linux-gnu" -type f -exec cp {} release-assets/open-coreui-${VERSION}-aarch64-unknown-linux-gnu \; 2>/dev/null || true
          [ -d "artifacts/build-x86_64-apple-darwin" ] && find artifacts/build-x86_64-apple-darwin -name "open-coreui-x86_64-apple-darwin" -type f -exec cp {} release-assets/open-coreui-${VERSION}-x86_64-apple-darwin \; 2>/dev/null || true
          [ -d "artifacts/build-aarch64-apple-darwin" ] && find artifacts/build-aarch64-apple-darwin -name "open-coreui-aarch64-apple-darwin" -type f -exec cp {} release-assets/open-coreui-${VERSION}-aarch64-apple-darwin \; 2>/dev/null || true
          [ -d "artifacts/build-x86_64-pc-windows-msvc" ] && find artifacts/build-x86_64-pc-windows-msvc -name "open-coreui-x86_64-pc-windows-msvc.exe" -type f -exec cp {} release-assets/open-coreui-${VERSION}-x86_64-pc-windows-msvc.exe \; 2>/dev/null || true
          [ -d "artifacts/build-aarch64-pc-windows-msvc" ] && find artifacts/build-aarch64-pc-windows-msvc -name "open-coreui-aarch64-pc-windows-msvc.exe" -type f -exec cp {} release-assets/open-coreui-${VERSION}-aarch64-pc-windows-msvc.exe \; 2>/dev/null || true

          # Copy and rename slim backend binaries with version (only if they exist)
          [ -d "artifacts/backend-slim-x86_64-unknown-linux-gnu" ] && find artifacts/backend-slim-x86_64-unknown-linux-gnu -name "open-coreui-slim-x86_64-unknown-linux-gnu" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-x86_64-unknown-linux-gnu \; 2>/dev/null || true
          [ -d "artifacts/backend-slim-aarch64-unknown-linux-gnu" ] && find artifacts/backend-slim-aarch64-unknown-linux-gnu -name "open-coreui-slim-aarch64-unknown-linux-gnu" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-aarch64-unknown-linux-gnu \; 2>/dev/null || true
          [ -d "artifacts/backend-slim-x86_64-apple-darwin" ] && find artifacts/backend-slim-x86_64-apple-darwin -name "open-coreui-slim-x86_64-apple-darwin" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-x86_64-apple-darwin \; 2>/dev/null || true
          [ -d "artifacts/backend-slim-aarch64-apple-darwin" ] && find artifacts/backend-slim-aarch64-apple-darwin -name "open-coreui-slim-aarch64-apple-darwin" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-aarch64-apple-darwin \; 2>/dev/null || true
          [ -d "artifacts/backend-slim-x86_64-pc-windows-msvc" ] && find artifacts/backend-slim-x86_64-pc-windows-msvc -name "open-coreui-slim-x86_64-pc-windows-msvc.exe" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-x86_64-pc-windows-msvc.exe \; 2>/dev/null || true
          [ -d "artifacts/backend-slim-aarch64-pc-windows-msvc" ] && find artifacts/backend-slim-aarch64-pc-windows-msvc -name "open-coreui-slim-aarch64-pc-windows-msvc.exe" -type f -exec cp {} release-assets/open-coreui-slim-${VERSION}-aarch64-pc-windows-msvc.exe \; 2>/dev/null || true

          echo "Release assets prepared:"
          ls -lh release-assets/ || echo "No release assets found"

      - name: Generate Checksums
        run: |
          cd release-assets
          if [ -n "$(ls -A)" ]; then
            sha256sum * > SHA256SUMS
            cat SHA256SUMS
          else
            echo "No files to generate checksums for"
          fi

      - name: Determine Release Type
        id: release_info
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use custom tag if provided, otherwise auto-generate
            if [[ -n "${{ inputs.release_tag }}" ]]; then
              echo "is_release=false" >> $GITHUB_OUTPUT
              echo "tag_name=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
              echo "prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
              echo "tag_name=manual-$(git rev-parse --short HEAD)-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
              echo "prerelease=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "tag_name=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate Release Body
        id: generate_body
        run: |
          TAG="${{ steps.release_info.outputs.tag_name }}"
          REPO="${{ github.repository }}"
          IS_RELEASE="${{ steps.release_info.outputs.is_release }}"
          VERSION=$(cat src-tauri/tauri.conf.json | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')

          if [ "$IS_RELEASE" == "true" ]; then
            WARNING=""
          else
            WARNING="**⚠️ Development build - may be unstable**"$'\n\n'
          fi

          cat > release_body.md << 'EOF'
          ${WARNING}## Desktop Application

          | Platform | Architecture | Download |
          |----------|-------------|----------|
          | Windows | x64 | [Open.CoreUI.Desktop_${VERSION}_x64-setup.exe](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_x64-setup.exe) / [.msi](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_x64_en-US.msi) |
          | Windows | ARM64 | [Open.CoreUI.Desktop_${VERSION}_arm64-setup.exe](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_arm64-setup.exe) / [.msi](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_arm64_en-US.msi) |
          | macOS | Intel | [Open.CoreUI.Desktop_${VERSION}_x64.dmg](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_x64.dmg) |
          | macOS | Apple Silicon | [Open.CoreUI.Desktop_${VERSION}_aarch64.dmg](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_aarch64.dmg) |
          | Linux | x64 | [Open.CoreUI.Desktop_${VERSION}_amd64.deb](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_amd64.deb) / [.rpm](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop-${VERSION}-1.x86_64.rpm) |
          | Linux | ARM64 | [Open.CoreUI.Desktop_${VERSION}_arm64.deb](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop_${VERSION}_arm64.deb) / [.rpm](https://github.com/${REPO}/releases/download/${TAG}/Open.CoreUI.Desktop-${VERSION}-1.aarch64.rpm) |

          > **macOS Users**: If you see "app is damaged" error, run this command in Terminal App:
          >
          > ```bash
          > sudo xattr -d com.apple.quarantine "/Applications/Open CoreUI Desktop.app"
          > ```

          ## Backend Server (Full - With Embedded Frontend)

          | Platform | Architecture | Binary |
          |----------|-------------|--------|
          | Linux | x64 | [open-coreui-${VERSION}-x86_64-unknown-linux-gnu](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-x86_64-unknown-linux-gnu) |
          | Linux | ARM64 | [open-coreui-${VERSION}-aarch64-unknown-linux-gnu](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-aarch64-unknown-linux-gnu) |
          | macOS | Intel | [open-coreui-${VERSION}-x86_64-apple-darwin](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-x86_64-apple-darwin) |
          | macOS | Apple Silicon | [open-coreui-${VERSION}-aarch64-apple-darwin](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-aarch64-apple-darwin) |
          | Windows | x64 | [open-coreui-${VERSION}-x86_64-pc-windows-msvc.exe](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-x86_64-pc-windows-msvc.exe) |
          | Windows | ARM64 | [open-coreui-${VERSION}-aarch64-pc-windows-msvc.exe](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-${VERSION}-aarch64-pc-windows-msvc.exe) |

          ## Backend Server (Slim - No Frontend)

          **Lightweight API-only binaries (~70% smaller). Use when running frontend separately.**

          | Platform | Architecture | Binary |
          |----------|-------------|--------|
          | Linux | x64 | [open-coreui-slim-${VERSION}-x86_64-unknown-linux-gnu](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-x86_64-unknown-linux-gnu) |
          | Linux | ARM64 | [open-coreui-slim-${VERSION}-aarch64-unknown-linux-gnu](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-aarch64-unknown-linux-gnu) |
          | macOS | Intel | [open-coreui-slim-${VERSION}-x86_64-apple-darwin](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-x86_64-apple-darwin) |
          | macOS | Apple Silicon | [open-coreui-slim-${VERSION}-aarch64-apple-darwin](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-aarch64-apple-darwin) |
          | Windows | x64 | [open-coreui-slim-${VERSION}-x86_64-pc-windows-msvc.exe](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-x86_64-pc-windows-msvc.exe) |
          | Windows | ARM64 | [open-coreui-slim-${VERSION}-aarch64-pc-windows-msvc.exe](https://github.com/${REPO}/releases/download/${TAG}/open-coreui-slim-${VERSION}-aarch64-pc-windows-msvc.exe) |
          EOF

          # Replace variables
          sed -i "s|\${WARNING}|${WARNING}|g" release_body.md
          sed -i "s|\${REPO}|${REPO}|g" release_body.md
          sed -i "s|\${TAG}|${TAG}|g" release_body.md
          sed -i "s|\${VERSION}|${VERSION}|g" release_body.md

          {
            echo "body<<EOFMARKER"
            cat release_body.md
            echo "EOFMARKER"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.is_release == 'true' && format('Release {0}', steps.release_info.outputs.tag_name) || format('Development Build ({0})', steps.release_info.outputs.tag_name) }}
          body: ${{ steps.generate_body.outputs.body }}
          files: release-assets/*
          prerelease: ${{ steps.release_info.outputs.prerelease }}
          draft: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
