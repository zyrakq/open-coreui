name: Reusable (Build Docker Images)

on:
  workflow_call:
    inputs:
      image_types:
        description: 'Image types to build (all, backend, frontend, complex, or comma-separated)'
        required: false
        type: string
        default: 'all'
      docker_platforms:
        description: 'Docker platforms (all, linux-x64, linux-arm64, or comma-separated)'
        required: false
        type: string
        default: 'all'
      version:
        description: 'Version for tagging (e.g., 1.2.3)'
        required: true
        type: string
      update_latest_tag:
        description: 'Whether to update the latest tag'
        required: false
        type: boolean
        default: false
      artifact_name:
        description: 'Artifact name prefix'
        required: false
        type: string
        default: 'open-coreui'
    outputs:
      image_types_built:
        description: 'Comma-separated list of successfully built image types'
        value: ${{ jobs.summary.outputs.image_types_built }}

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_backend: ${{ steps.check.outputs.build_backend }}
      build_frontend: ${{ steps.check.outputs.build_frontend }}
      build_complex: ${{ steps.check.outputs.build_complex }}
      platforms: ${{ steps.check.outputs.platforms }}
      owner_lower: ${{ steps.check.outputs.owner_lower }}
      image_types_built: ${{ steps.check.outputs.image_types_built }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Check which images to build
        id: check
        run: |
          chmod +x .github/scripts/docker/check-images.sh
          .github/scripts/docker/check-images.sh \
            "${{ inputs.image_types }}" \
            "${{ inputs.docker_platforms }}" \
            "${{ github.repository_owner }}"
  
  summary:
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend, build-complex]
    if: always()
    outputs:
      image_types_built: ${{ steps.summary.outputs.image_types_built }}
    steps:
      - name: Generate summary of built images
        id: summary
        run: |
          BUILT_IMAGES=""
          
          if [[ "${{ needs.build-backend.result }}" == "success" ]]; then
            BUILT_IMAGES="${BUILT_IMAGES}backend,"
          fi
          
          if [[ "${{ needs.build-frontend.result }}" == "success" ]]; then
            BUILT_IMAGES="${BUILT_IMAGES}frontend,"
          fi
          
          if [[ "${{ needs.build-complex.result }}" == "success" ]]; then
            BUILT_IMAGES="${BUILT_IMAGES}complex,"
          fi
          
          # Remove trailing comma
          BUILT_IMAGES="${BUILT_IMAGES%,}"
          
          echo "image_types_built=${BUILT_IMAGES}" >> $GITHUB_OUTPUT
          echo "Built Docker images: ${BUILT_IMAGES}"

  build-backend:
    needs: prepare
    if: needs.prepare.outputs.build_backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Download Backend Slim Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-slim-*
          merge-multiple: true

      - name: Prepare build context
        run: |
          chmod +x .github/scripts/docker/prepare-backend-context.sh
          .github/scripts/docker/prepare-backend-context.sh "${{ inputs.artifact_name }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/open-coreui-backend
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version }}
            type=semver,pattern={{major}},value=${{ inputs.version }}
            type=raw,value=latest,enable=${{ inputs.update_latest_tag }}
          labels: |
            org.opencontainers.image.title=Open CoreUI Backend
            org.opencontainers.image.description=Lightweight backend server (slim, no frontend)
            org.opencontainers.image.licenses=Apache-2.0

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: docker/build/backend/context
          file: docker/build/backend/Dockerfile
          platforms: ${{ needs.prepare.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    needs: prepare
    if: needs.prepare.outputs.build_frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Download Frontend Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/frontend-build
          pattern: frontend-build

      - name: Prepare build context
        run: |
          chmod +x .github/scripts/docker/prepare-frontend-context.sh
          .github/scripts/docker/prepare-frontend-context.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/open-coreui-frontend
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version }}
            type=semver,pattern={{major}},value=${{ inputs.version }}
            type=raw,value=latest,enable=${{ inputs.update_latest_tag }}
          labels: |
            org.opencontainers.image.title=Open CoreUI Frontend
            org.opencontainers.image.description=Static frontend build served by Ferron
            org.opencontainers.image.licenses=BSD-3-Clause

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: docker/build/frontend/context
          file: docker/build/frontend/Dockerfile
          platforms: ${{ needs.prepare.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-complex:
    needs: prepare
    if: needs.prepare.outputs.build_complex == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Download Backend Full Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: backend-full-*
          merge-multiple: true

      - name: Prepare build context
        run: |
          chmod +x .github/scripts/docker/prepare-complex-context.sh
          .github/scripts/docker/prepare-complex-context.sh "${{ inputs.artifact_name }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ needs.prepare.outputs.owner_lower }}/open-coreui
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version }}
            type=semver,pattern={{major}},value=${{ inputs.version }}
            type=raw,value=latest,enable=${{ inputs.update_latest_tag }}
          labels: |
            org.opencontainers.image.title=Open CoreUI
            org.opencontainers.image.description=Full backend server with embedded frontend
            org.opencontainers.image.licenses=Apache-2.0 AND BSD-3-Clause

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: docker/build/complex/context
          file: docker/build/complex/Dockerfile
          platforms: ${{ needs.prepare.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max